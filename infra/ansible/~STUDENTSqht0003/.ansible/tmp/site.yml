# infra/ansible/site.yml
---
- name: Provision CyberOracle local dev environment
  hosts: local
  become: true

  vars:
    postgres_db_name: "cyberoracle"
    postgres_user: "cyberoracle"
    postgres_password: "cyberoracle"
    postgres_port: "5433"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base packages
      apt:
        name:
          - git
          - curl
          - build-essential
          - python3
          - python3-venv
          - python3-pip
        state: present

    - name: Install PostgreSQL and contrib
      apt:
        name:
          - postgresql
          - postgresql-contrib
        state: present

    - name: Ensure PostgreSQL service is running
      service:
        name: postgresql@14-main
        state: started
        enabled: true

    - name: Create PostgreSQL user if missing
      shell: |
        sudo -u postgres psql -p {{ postgres_port }} -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_user }}'" | grep -q 1 \
        || sudo -u postgres psql -p {{ postgres_port }} -c "CREATE USER {{ postgres_user }} WITH PASSWORD '{{ postgres_password }}';"
      args:
        executable: /bin/bash

    - name: Create PostgreSQL database if missing
      shell: |
        sudo -u postgres psql -p {{ postgres_port }} -tc "SELECT 1 FROM pg_database WHERE datname='{{ postgres_db_name }}'" | grep -q 1 \
        || sudo -u postgres psql -p {{ postgres_port }} -c "CREATE DATABASE {{ postgres_db_name }} OWNER {{ postgres_user }};"
      args:
        executable: /bin/bash